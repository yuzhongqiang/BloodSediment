/*
* Printer
*
* printer.c
*
*/

#include <stm32f10x_lib.h>
#include <stdio.h>
#include "sys.h"
#include "printer.h"
#include "channel.h"
#include "delay.h"

extern	struct tube tubes[MAX_CHANNELS];

void _printer_init(void)
{
	u8 buf[2] = {0x1b, 0x40};
	printer_do_print(buf, sizeof(buf));
	delay_ms(200);
}

/*
	Physical left margin = dist * 0.125mm
*/
void _set_line_dist(u8 dist)
{
	u8 buf[3] = {0x1b, 0x33, 0x00};
	buf[2] = dist;
	printer_do_print(buf, sizeof(buf));
	delay_ms(200);
}


/*
	Physical left margin = cnt * 0.125mm
*/
void _set_left_margin(u16 cnt)
{
	u8 buf[4] = {0x1d, 0x4c, 0x00, 0x00};
	buf[2] = (cnt & 0x00ff);
	buf[3] = ((cnt & 0xff00) >> 16);
	printer_do_print(buf, sizeof(buf));
	delay_ms(200);
}

/*
	Physical left margin = cnt * 0.125mm
*/
void _set_width(u16 cnt)
{
	u8 buf[4] = {0x1d, 0x57, 0x00, 0x00};
	buf[2] = (cnt & 0x00ff);
	buf[3] = ((cnt & 0xff00) >> 16);
	printer_do_print(buf, sizeof(buf));
	delay_ms(200);
}

void _print_xais(void)
{
	u8 axis_buf[] = {0x1b, 0x2a, 0x00, 0x00, 0x00, 
 /*0cm*/0xff, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,   /*1cm*/
		0xf0, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,    
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,   /*2cm*/
		0xf0, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,   /*3cm*/
		0xf0, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,   /*4cm*/
		0xf0, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,   /*5cm*/
		0xf0, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
		0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,   /*6cm*/
		0x91, 0x52, 0x34, 0x18, 0x10};
	u16 cnt = sizeof(axis_buf) - 5;
	
	axis_buf[3] = (u8)(cnt & 0x00ff);
	axis_buf[4] = (u8)((cnt & 0xff00) >> 16);
	printer_do_print(axis_buf, sizeof(axis_buf));
	delay_ms(200);	
}

/*
	units of data is 0.01mm
*/
void _print_data(u32 value)
{
	u8 data_buf[] = {0x1b, 0x2a, 0x00, 0x00, 0x00,
 /*0cm*/0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   /*1cm*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   /*2cm*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   /*3cm*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   /*4cm*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,   /*5cm*/
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}; /*6cm*/
	u32 cnt = (value*180 /6000) - 1;
	u8 i;

	for (i=6; i<6+cnt; i++)
		data_buf[i] = 0x18;
	
	data_buf[3] = (u8)(cnt  & 0x00ff);
	data_buf[4] = (u8)((cnt & 0xff00) >> 16);
	printer_do_print(data_buf, cnt+6);   /* YES, +6 */
	delay_ms(200);	
}

void _print_yaxis(u8 istop)
{
	u8 buf[] = {0x1b, 0x2a, 0x00, 0x00, 0x00, 0xff}; 
	
	buf[3] = (u8)(1 & 0x00ff);
	buf[4] = (u8)((1 & 0xff00) >> 16);
	printer_do_print(buf, sizeof(buf));
	delay_ms(200);	
}

/*
	USART3中断服务程序
	注意,读取USARTx->SR能避免莫名其妙的错误   	
*/

/* 打印机使用USART3 */
void printer_init(u32 baud)
{
	float temp;
	u16 mantissa, fraction;
		   
	RCC->APB1ENR |= 1 << 18;  	//使能串口时钟  OK
	GPIOB->CRH &= 0XFFFF00FF; 
	GPIOB->CRH |= 0X00008B00;	//IO状态设置  OK
		  
	RCC->APB1RSTR |= (1 << 18);   //复位串口3	 OK
	RCC->APB1RSTR &= ~(1 << 18);//停止复位	   	  OK

	//波特率设置
	temp = (float)(PCLK1_FREQ / (baud * 16));	//得到USARTDIV
	mantissa = temp;						 	//得到整数部分
	fraction = (temp - mantissa) * 16; 			//得到小数部分	 
    mantissa <<= 4;
	mantissa += fraction; 
 	USART3->BRR = mantissa; // 波特率设置	 
	USART3->CR1 |= 0X200C;  // 1位停止,无校验位.

	/* 打印机初始化*/
	_printer_init();
}

u8 print_ch(char ch)
{
	while ((USART3->SR & 0x40) == 0)	//等待总线空闲
		;

	USART3->DR = ch;      
	return ch;
}

/* str必须以\0字符结尾 */
void print_str(char* str)
{
 	while (*str)
		print_ch(*str++);
}

void printer_main(void)
{
	u8 i, j;
      char buf[100];

	for (i=0; i<MAX_CHANNELS; i++)
	{
		if (tubes[i].status == CHN_STATUS_FINISH)
		{
		    print_str("*************************\n");

                for (j=0; j<13; j++)
                {
                    sprintf(buf, "ESR_NO.%d_Time%d: %d\n", i, j+1, tubes[i].values[j]/2);
					print_str(buf);
                }

            print_str("*************************\n");
			delay_ms(1000);
			tubes[i].status = CHN_STATUS_NONE;
		}
            else
                continue;
	}
}

void printer_test(void)
{
 	char *str = "Hello, this is a test";
	
	print_str(str);
	print_ch(0x0a);
}

void printer_do_print(u8 *buf, u16 len)
{

	u16 i;
	for (i=0; i<len; i++)
		print_ch(buf[i]);
}

void printer_graph(void)
{
	int i;
	u32 values[] = {5000, 4800, 4500, 4400, 4300, 4000, 3900,
				   3800, 3750, 3500, 3300, 3200, 2900};
	
	for (i=12; i>=0; i--) {
		_print_yaxis(0);
		_print_data(values[i]);
	}
	_print_yaxis(1);
	_print_xais();
	print_ch(0x0a);
}

